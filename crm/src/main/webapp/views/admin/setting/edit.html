#@layout() #define main()
<div class="layui-card-header">系统设置</div>
<div class="layui-card-body">

	<div class='layui-tab layui-tab-brief' lay-filter='TabBrief'>
		<ul class="layui-tab-title">
			<li class="layui-this">基本设置</li>
			<li>邮件设置</li>
		</ul>
		<form class="layui-tab-content layui-form"
				action="/admin/setting/save">
		<div class='layui-tab-item layui-show'>
		<input name='setting.id' value="#(setting.id)" style="display:none;">
				<div class='layui-form-item'>
					<div class='layui-inline theme-required'>
						<div class='layui-form-label'>网站名称:</div>
						<div class='layui-input-inline'>
							<input name='setting.siteName' value="#(setting.siteName)" lay-verify='required'
								class='layui-input' autocomplete='off' placeholder='请输入' />
						</div>
					</div>
				</div>
				<!-- <div class='layui-form-item'>
					<div class='layui-inline theme-required'>
						<div class='layui-form-label'>网站网址:</div>
						<div class='layui-input-inline'>
							<input name='setting.siteUrl' value="#(setting.siteUrl)" lay-verify='required'
								class='layui-input' autocomplete='off' placeholder='请输入' />
						</div>
					</div>
				</div> -->
				<div class='layui-form-item'>
			<div class="layui-inline theme-required">
	     		<label class="layui-form-label">logo</label>
	      		<a  href="#(setting.logo)" #if(!setting.logo??) style="display:none;" #end  class="viewLogo" target="_blank">查看</a>
	            <input type="text" style="display:none;" class="logo" value="#(setting.logo)" lay-verify='required' name="setting.logo" autocomplete="off" class="layui-input" style="width: 250px;">
	            <button type="button" class="layui-btn" id="upload5">
           			<i class="layui-icon">&#xe67c;</i>上传图片
        		</button>
	   		</div>
	   		</div>
			<!-- 	<div class='layui-form-item'>
					<div class='layui-inline '>
						<div class='layui-form-label'>联系地址:</div>
						<div class='layui-input-inline'>
							<input name='setting.address' value="#(setting.address)" 
								class='layui-input' autocomplete='off' placeholder='请输入' />
						</div>
					</div>
				</div>
				<div class='layui-form-item'>
					<div class='layui-inline'>
						<div class='layui-form-label'>联系电话:</div>
						<div class='layui-input-inline'>
							<input name='setting.phone' value="#(setting.phone)" 
								class='layui-input' autocomplete='off' placeholder='请输入' />
						</div>
					</div>
				</div>
				<div class='layui-form-item'>
					<div class='layui-inline'>
						<div class='layui-form-label'>邮政编码:</div>
						<div class='layui-input-inline'>
							<input name='setting.zipCode' value="#(setting.zipCode)" 
								class='layui-input' autocomplete='off' placeholder='请输入' />
						</div>
					</div>
				</div>
				<div class='layui-form-item'>
					<div class='layui-inline '>
						<div class='layui-form-label'>E-mail:</div>
						<div class='layui-input-inline'>
							<input name='setting.email' value="#(setting.email)" 
								class='layui-input' autocomplete='off' placeholder='请输入' />
						</div>
					</div>
				</div> -->
				<div class='layui-form-item'>
					<div class='layui-inline '>
						<div class='layui-form-label'>备案编号:	</div>
						<div class='layui-input-inline'>
							<input name='setting.certtext' value="#(setting.certtext)" 
								class='layui-input' autocomplete='off' placeholder='请输入' />
						</div>
					</div>
				</div>
				</div>
				<div class='layui-tab-item'>
				<div class='layui-form-item'>
					<div class='layui-inline theme-required'>
						<div class='layui-form-label'>SMTP服务器地址:</div>
						<div class='layui-input-inline'>
							<input name='setting.smtpHost' id="smtpHost" value="#(setting.smtpHost)" lay-verify='required'
								class='layui-input' autocomplete='off' placeholder='请输入' />
						</div>
					</div>
				</div>
					<div class='layui-form-item'>
					<div class='layui-inline theme-required'>
						<div class='layui-form-label'>SMTP服务器端口:</div>
						<div class='layui-input-inline'>
							<input name='setting.smtpPort' id="smtpPort"  value="#(setting.smtpPort)" lay-verify='required'
								class='layui-input' autocomplete='off' placeholder='请输入' />
						</div>
					</div>
				</div>
					<div class='layui-form-item'>
					<div class='layui-inline theme-required'>
						<div class='layui-form-label'>SMTP用户名:</div>
						<div class='layui-input-inline'>
							<input name='setting.smtpUsername'  id="smtpUsername" value="#(setting.smtpUsername)" lay-verify='required'
								class='layui-input' autocomplete='off' placeholder='请输入' />
						</div>
					</div>
				</div>
				<div class='layui-form-item'>
					<div class='layui-inline'>
						<div class='layui-form-label'>SMTP密码:</div>
						<div class='layui-input-inline'>
							<input name='setting.smtpPassword' id="smtpPassword" value="#(setting.smtpPassword)" 
								class='layui-input' autocomplete='off' placeholder='请输入' />
						</div>
					</div>
				</div>
				<!-- <div class='layui-form-item'>
					<div class='layui-inline'>
						<div class='layui-form-label' style="width: 120px;">SMTP是否启用SSL:</div>
						<div class='layui-input-inline'>
						<input type="checkbox" name="setting.smtpSSLEnabled" id="smtpSSLEnabled" lay-skin="primary" value="true" #if(setting.smtpSSLEnabled=='1')checked #end>
					    </div>
					</div>
				</div> -->
				<div class='layui-form-item'>
					<div class='layui-inline theme-required'>
						<div class='layui-form-label' style="width: 120px;">发件人邮箱:</div>
						<div class='layui-input-inline'>
						<input name='setting.smtpFromMail' value="#(setting.smtpFromMail)" lay-verify='required'
								class='layui-input' autocomplete='off' id="smtpFromMail" placeholder='请输入' />
								<a href="javascript:;" style="color:green" id="testSmtp">邮件测试</a>
					    </div>
					</div>
				</div>
					<div class='layui-form-item' id="senDiv" style="display:none;">
					<div class='layui-inline '>
						<div class='layui-form-label' style="width: 120px;">收件人邮箱:</div>
						<div class='layui-input-inline'>
						<input name='toMail' value=""  id="toMail"
								class='layui-input' autocomplete='off' placeholder='请输入' />
							<input type="button" id="sendMail"  class="layui-btn" value="发送邮件">
					    </div>
					</div>
				</div>
				</div>
					<div class="layui-form-item">
				<div class="layui-input-block" style='float: right'>
					<button class="layui-btn" lay-submit lay-filter="save">确定</button>
					<a class="layui-btn layui-btn-primary"
						href='javascript:history.go(-1);'>返回</a>
				</div>
			</div>
				</form>
				</div>
				</div>
<style>
.layui-form-label {
	white-space: nowrap;
	width: 93px
}

.layui-input-block {
	margin-left: 123px
}

.layui-tab-content {
	padding: 20px 10px 10px 0
}

.layui-form-item .layui-inline {
	margin-bottom: 0
}
/*
	.theme-required .layui-form-label:before{position: absolute;display: block;width: 5px;height:5px;border-radius: 50%;top:50%;left:0px;transform:translate3d(0,-50%,0);background-color: #c00;content:''}
	*/
.theme-required .layui-form-label:before {
	display: inline-block;
	vertical-align: top;
	margin-right: 3px;
	width: 6px;
	height: 6px;
	border-radius: 50%;
	background-color: #c00;
	content: ''
}

.layui-elem-quote .layui-form-item:last-of-type {
	margin-bottom: 0
}
</style>
<script type="text/javascript">
$smsBalance = $("#smsBalance");

var $smtpHost = $("#smtpHost");
var $smtpPort = $("#smtpPort");
var $smtpUsername = $("#smtpUsername");
var $smtpPassword = $("#smtpPassword");
var $smtpSSLEnabled = $("#smtpSSLEnabled");
var $smtpFromMail = $("#smtpFromMail");
var $toMail = $("#toMail");
var $sendMail = $("#sendMail");
var $testSmtp =$("#testSmtp");

//邮件测试
$testSmtp.click(function() {
	$(this).hide();
	$("#senDiv").show();
});

// 发送邮件
$sendMail.click(function() {
	$.ajax({
		url: "test_smtp",
		type: "POST",
		data: {smtpHost: $smtpHost.val(),
			smtpPort: $smtpPort.val(),
			smtpUsername: $smtpUsername.val(),
			smtpPassword: $smtpPassword.val(), 
			smtpSSLEnabled: $smtpSSLEnabled.prop("checked"),
			smtpFromMail: $smtpFromMail.val(), 
			toMail: $toMail.val()},
		dataType: "json",
		cache: false,
		success: function(data) {
			layer.msg(data.message)
		}
	});
});

//短信余额查询
$smsBalance.click(function() {
	var $this = $(this);
	$.ajax({
		url: "sms_balance",
		type: "GET",
		dataType: "json",
		cache: false,
		beforeSend: function() {
			$this.prop("disabled", true).after('<span class="loadingIcon">&nbsp;<\/span>');
		},
		success: function(data) {
			console.log(data);
			$this.prop("disabled", false).nextAll("span").remove();
			if (data.code==1) {
				layer.msg("您的余额为:"+data.data+"条");
			} else {
				layer.msg(data.message);
			}
		}
	});
	return false;
});

	layui.use(['form','layer','layedit'], function(){
    	var form = layui.form,
    		layer = layui.layer,
    		layedit = layui.layedit,
    		$ = layui.$;
    	
    	
    	//监听提交
    	form.on('submit(save)', function(data){
    		var types="";
    		$("input:checkbox[name='captcha_types']:checked").each(function(){
    			types +=$(this).val()+",";
    		});
    		console.log(types);
    		$("input[name='setting.captchaTypes']").val(types.substr(0,types.length-1));
			$.post($(".layui-form").attr('action'), $(".layui-form").serialize(),
				function(res) {
					layer.msg(res.message); 
		    		if(res.code == 1) {
		    			location.href="/admin/setting/edit";
		    		}
				}, "json");
    		
    		return false;
    	});
  	});   
	
	layui.use('upload', function(){
		  var upload = layui.upload;
		   
		  var uploadInst = upload.render({
			    elem: '#upload,#upload2,#upload3,#upload4,#upload5'
			    ,url: '/common/file/upload'
			    ,before: function(obj){
			      //预读本地文件示例，不支持ie8
			      obj.preview(function(index, file, result){
			        //图片链接（base64）
			        console.log(index); //得到文件索引
			        console.log(file); //得到文件对象
			        //console.log(result); //得到文件base64编码，比如图片
			        $("#yudu").html("<span>名字："+file.name+"</span>"+"<span>大小："+file.size+"</span>");
			      });
			    }
			    ,done: function(res){
			        //alert(res.code);
			      //如果上传失败
			      if(res.code > 0){
			        return layer.msg('上传失败');
			      }
			      //上传成功
			      layer.msg("上传成功");
			      this.item.parent().find('.logo').val(res.data.filePath);
			      this.item.parent().find(".viewLogo").show();
			      this.item.parent().find(".viewLogo").attr("href",res.data.filePath);
			    }
			    ,error: function(){
			      //演示失败状态，并实现重传
			      var demoText = $('#demoText');
			      demoText.html('<span style="color: #FF5722;">上传失败</span> <a class="layui-btn layui-btn-mini demo-reload">重试</a>');
			      demoText.find('.demo-reload').on('click', function(){
			        uploadInst.upload();
			      });
			    }
			  });
		});
</script>
#end